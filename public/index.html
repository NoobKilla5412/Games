<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Noob Killa's OS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      margin: 0px;
    }

    #containerGames,
    #containerApps {
      width: 98%;
      /* margin: 0px; */
      margin: 1%;
      display: flex;
      align-content: flex-start;
      flex-wrap: wrap;
    }

    .container-fluid,
    #game {
      margin: 0px;
      padding: 0px;
    }

    .container-fluid {
      height: calc(100vh - 65px);
      overflow-y: scroll;
    }

    #homeBar {
      padding: 16px;
      position: absolute;
      bottom: 0px;
      width: 100%;
      background: #cccccc;
      margin: 0px;
      text-align: center;
    }

    img {
      width: 75px;
      height: 75px;
      border: 1px black solid;
      border-radius: .5rem;
      background-color: black;
      cursor: pointer;
    }

    iframe {
      width: 100%;
      left: 0px;
      right: 0px;
      height: calc(100vh - 65px);
    }

    #game {
      height: calc(100vh - 65px);
      display: none;
    }

    div.app {
      display: inline-block;
      text-align: center;
      width: 100px;
    }

    button {
      border-width: 2px;
      border-style: outset;
      border-color: buttonborder;
      border-image: initial;
      border-radius: .5rem;
    }

    .show {
      z-index: 1000;
      position: absolute;
      background-color: #C0C0C0;
      border: 1px solid blue;
      padding: 2px;
      display: block;
      margin: 0;
      list-style-type: none;
      list-style: none;
    }

    .hide {
      display: none;
    }

    #home {
      width: 35px;
      height: 30px;
      border-radius: 100px;
    }
  </style>
</head>

<body>
  <div class="container-fluid" id="container">
    <div id="containerGames"></div>
    <div id="containerApps"></div>
  </div>
  <div id="game"></div>
  <div id="homeBar">
    <button onclick="home();" id="home"></button>
  </div>
  <div id="r-click-div"></div>
  <script>
    var apps = {};
    var defaultApps = {};
    var games = {};
    var settings = { darkMode: false };
    if (!localStorage.getItem('settings')) {
      localStorage.setItem('settings', JSON.stringify(settings));
    } else {
      settings = JSON.parse(localStorage.getItem('settings'));
    }

    if (settings.darkMode) {
      document.body.style.background = 'black';
      document.body.style.color = 'white';
    } else {
      document.body.style.background = 'white';
      document.body.style.color = 'black';
    }
    var activeApp;
    var appLibrary = {};
    function mouseX(e) {
      if (e.pageX) {
        return e.pageX;
      } else if (e.clientX) {
        return e.clientX + (document.documentElement.scrollLeft ?
          document.documentElement.scrollLeft :
          document.body.scrollLeft);
      } else {
        return null;
      }
    }

    function mouseY(e) {
      if (e.pageY) {
        return e.pageY;
      } else if (e.clientY) {
        return e.clientY + (document.documentElement.scrollTop ?
          document.documentElement.scrollTop :
          document.body.scrollTop);
      } else {
        return null;
      }
    }
    function load(game) {
      if (game.title == 'Update') {
        location.reload();
      } else {
        if (game.options) {
          document.getElementById('game').innerHTML = `<iframe src="${game.link}" ${game.options} />`;
        } else {
          document.getElementById('game').innerHTML = `<iframe src="${game.link}" />`;
        }
        document.getElementById('containerGames').style.display = 'none';
        document.getElementById('containerApps').style.display = 'none';
        document.title = `${game.title} ${game.version ? 'v' + game.version : ''}`;
      }
      activeApp = game.title;
      document.head.removeChild(document.getElementsByTagName('title')[0]);
      let newTitle = document.createElement('title');
      newTitle.innerHTML = `${game.title} &#8211; Noob Killa&rsquo;s OS`;
      document.head.appendChild(newTitle);
      document.getElementById('game').style.display = 'block';
      document.getElementById('container').style.display = 'none';
    }

    function deleteGame(game, type = 'game') {
      if (confirm(`Are you sure you want to delete ${game.title}?`)) {
        appLibrary[game.title] = false;
        localStorage.setItem('apps', JSON.stringify(appLibrary));
        if (type == 'game') {
          if (!confirm(`Do you want to keep save data for ${game.title}? Ok for save, Cancel for delete`)) {
            localStorage.removeItem(game.id);
            if (game.otherData) {
              game.otherData.forEach(dataName => {
                localStorage.removeItem(dataName);
              });
            }
            game?.delAction();
          }
        }
        location.reload();
      }
    }
    function home() {
      if (activeApp != 'App Store' && activeApp != 'Settings') {
        document.getElementById('game').innerHTML = '';
        document.getElementById('containerGames').style.display = 'flex';
        document.getElementById('containerApps').style.display = 'flex';
      } else {
        location.reload();
      }
      document.head.removeChild(document.getElementsByTagName('title')[0]);
      let newTitle = document.createElement('title');
      newTitle.innerHTML = 'Noob Killa\'s OS'
      document.head.appendChild(newTitle);
      document.getElementById('game').style.display = 'none';
      document.getElementById('container').style.display = 'block';
    }
    fetch('json/apps.json')
      .then((response) => response.json())
      .then((data) => {
        apps = data;
        fetch('json/defaultApps.json')
          .then((response) => response.json())
          .then((data1) => {
            defaultApps = data1;
            fetch('json/games.json')
              .then((response) => response.json())
              .then((data2) => {
                games = data2;
                if (!localStorage.getItem('apps')) {
                  localStorage.setItem('apps', JSON.stringify(appLibrary));
                } else {
                  appLibrary = JSON.parse(localStorage.getItem('apps'));
                }
                for (const game in games) {
                  if (Object.hasOwnProperty.call(games, game)) {
                    const value = games[game];
                    if (appLibrary[value.title]) {
                      document.getElementById('containerGames').innerHTML += `
            <br style="display:none" id="${game}Br" />
            <div class="app">
              <img src="${value.image}" id="${game}" class="image" /><br>
              <caption>
                ${value.title} ${value.version ? 'v' + value.version : ''}
              </caption>
            </div>`;
                      document.getElementById('r-click-div').innerHTML += `
            <div class="hide" id="rmenu-${game}">
              <button id="delete-${game}">Delete</button>
            </div>`;
                    }
                  }
                }
                for (const app in defaultApps) {
                  if (Object.hasOwnProperty.call(defaultApps, app)) {
                    const value = defaultApps[app];
                    document.getElementById('containerApps').innerHTML += `
            <br style="display:none" id="${app}Br" />
            <div class="app">
              <img src="${value.image}" id="${app}" class="image" ><br>
              <caption>
                ${value.title} ${value.version ? 'v' + value.version : ''}
              </caption>
            </div>`;
                  }
                }
                for (const app in apps) {
                  if (Object.hasOwnProperty.call(apps, app)) {
                    const value = apps[app];
                    if (appLibrary[value.title]) {
                      document.getElementById('containerApps').innerHTML += `
            <br style="display:none" id="${app}Br" />
            <div class="app">
              <img src="${value.image}" id="${app}" class="image" ><br>
              <caption>
                ${value.title} ${value.version ? 'v' + value.version : ''}
              </caption>
            </div>`;
                      document.getElementById('r-click-div').innerHTML += `
            <div class="hide" id="rmenu-${app}">
              <button id="delete-${app}">Delete</button>
            </div>`;
                    }
                  }
                }

                for (const game in games) {
                  if (Object.hasOwnProperty.call(games, game)) {
                    const value = games[game];
                    if (!value.link)
                      value.link = `games/${value.title}/Launch.html`;

                    if (appLibrary[value.title]) {
                      document.getElementById(game).onclick = () => load(value);
                      document.getElementById('delete-' + game).onclick = () => deleteGame(value);
                    }
                  }
                }

                for (const app in defaultApps) {
                  if (Object.hasOwnProperty.call(defaultApps, app)) {
                    const value = defaultApps[app];
                    document.getElementById(app).onclick = () => load(value);
                  }
                }
                for (const app in apps) {
                  if (Object.hasOwnProperty.call(apps, app)) {
                    const value = apps[app];
                    if (!value.link)
                      value.link = `apps/${value.title}/Launch.html`;
                    if (appLibrary[value.title]) {
                      document.getElementById(app).onclick = () => load(value);
                      document.getElementById('delete-' + app).onclick = () => deleteGame(value, 'app');
                    }
                  }
                }

                updateBr.style.display = 'initial';


                for (const game in games) {
                  if (Object.hasOwnProperty.call(games, game)) {
                    const value = games[game];
                    if (appLibrary[value.title]) {
                      document.getElementById(game).addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        document.getElementById(`rmenu-${game}`).className = 'show';
                        document.getElementById(`rmenu-${game}`).style.top = mouseY(event) + 'px';
                        document.getElementById(`rmenu-${game}`).style.left = mouseX(event) + 'px';
                      });
                    }
                  }
                }
                for (const app in apps) {
                  if (Object.hasOwnProperty.call(apps, app)) {
                    const value = apps[app];
                    if (appLibrary[value.title]) {
                      document.getElementById(app).addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        document.getElementById(`rmenu-${app}`).className = 'show';
                        document.getElementById(`rmenu-${app}`).style.top = mouseY(event) + 'px';
                        document.getElementById(`rmenu-${app}`).style.left = mouseX(event) + 'px';
                      });
                    }
                  }
                }
                for (const app in defaultApps) {
                  if (Object.hasOwnProperty.call(defaultApps, app)) {
                    const value = defaultApps[app];
                    document.getElementById(app).addEventListener('contextmenu', (e) => {
                      e.preventDefault();
                    });
                  }
                }

                document.addEventListener('click', (e) => {
                  for (const game in games) {
                    if (Object.hasOwnProperty.call(games, game)) {
                      const value = games[game];
                      if (appLibrary[value.title])
                        document.getElementById(`rmenu-${game}`).className = 'hide';
                    }
                  }
                  for (const app in apps) {
                    if (Object.hasOwnProperty.call(apps, app)) {
                      const value = apps[app];
                      if (appLibrary[value.title])
                        document.getElementById(`rmenu-${app}`).className = 'hide';
                    }
                  }
                });
              });
          });
      });
  </script>
</body>

</html>